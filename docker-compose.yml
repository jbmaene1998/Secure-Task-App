services:
  auth-db:
    image: mysql:8
    container_name: stms-auth-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: authdb
      MYSQL_USER: stms
      MYSQL_PASSWORD: stms_pw
    ports:
      - "3306:3306"
    volumes:
      - auth_db_data:/var/lib/mysql
      - ./backend/docker/mysql/authdb-init.sql:/docker-entrypoint-initdb.d/01-authdb.sql:ro
    networks:
      - stms-net
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot --silent"]
      interval: 10s
      timeout: 5s
      retries: 15

  task-db:
    image: mysql:8
    container_name: stms-task-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: taskdb
      MYSQL_USER: stms
      MYSQL_PASSWORD: stms_pw
    ports:
      - "3307:3306"
    volumes:
      - task_db_data:/var/lib/mysql
    networks:
      - stms-net
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot --silent"]
      interval: 10s
      timeout: 5s
      retries: 15

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.3
    container_name: stms-es
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 10s
      timeout: 5s
      retries: 10

    networks:
      - stms-net

  logstash:
    build:
      context: ./backend/docker/logstash
    container_name: stms-logstash
    environment:
      - xpack.monitoring.enabled=false
    ports:
      - "5000:5000"
      - "9600:9600"
    depends_on:
      - elasticsearch

    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/9600'"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s

    networks:
      - stms-net

  jenkins:
    build:
      context: ./backend/docker/jenkins
    image: jenkins/jenkins:lts-jdk21
    container_name: stms-jenkins
    profiles: ["jenkins"]
    user: root
    ports:
      - "9090:8080"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
      - CASC_JENKINS_CONFIG=/usr/local/jenkins-casc.yaml
    networks:
      - stms-net

  auth-service:
    build:
      context: ./backend
      dockerfile: docker/auth-service.Dockerfile
    image: stms-auth-service:latest
    container_name: stms-auth-service
    profiles: ["apps"]
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mysql://auth-db:3306/authdb
      SPRING_DATASOURCE_USERNAME: stms
      SPRING_DATASOURCE_PASSWORD: stms_pw
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_SECRET: "THIS_IS_A_SUPER_LONG_AND_SECURE_256_BIT_SECRET_KEY_123456"
      JWT_EXPIRATION_SECONDS: 3600
      LOGSTASH_HOST: logstash
      LOGSTASH_PORT: 5000
      APP_ENV: docker
    ports:
      - "8080:8080"
    networks:
      - stms-net
    depends_on:
      logstash:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      auth-db:
        condition: service_healthy

  task-service:
    build:
      context: ./backend
      dockerfile: docker/task-service.Dockerfile
    image: stms-task-service:latest
    container_name: stms-task-service
    profiles: ["apps"]
    restart: unless-stopped
    environment:
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mysql://task-db:3306/taskdb
      SPRING_DATASOURCE_USERNAME: stms
      SPRING_DATASOURCE_PASSWORD: stms_pw
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_SECRET: "THIS_IS_A_SUPER_LONG_AND_SECURE_256_BIT_SECRET_KEY_123456"
      JWT_EXPIRATION_SECONDS: 3600
      LOGSTASH_HOST: logstash
      LOGSTASH_PORT: 5000
      APP_ENV: docker
    ports:
      - "8081:8080"
    networks:
      - stms-net
    depends_on:
      logstash:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      task-db:
        condition: service_healthy

networks:
  stms-net:
    driver: bridge

volumes:
  auth_db_data:
  task_db_data:
  jenkins_home:
